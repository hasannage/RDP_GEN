name: Windows RDP Auto-Renew

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 350   # Ù…Ø¯Ø© ØªØ´ØºÙŠÙ„ ~6 Ø³Ø§Ø¹Ø§Øª

    steps:
    - name: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        echo "âœ… Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¬Ø§Ù‡Ø²Ø©"

    - name: ØªØ«Ø¨ÙŠØª ÙˆØªØ´ØºÙŠÙ„ Tailscale
      run: |
        choco install tailscale -y
        Start-Sleep -Seconds 10
        $tsExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
        & $tsExe up --authkey ${{ secrets.TAILSCALE_KEY }} --hostname GitHubRDP --accept-routes

    - name: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
      run: |
        net user githubadmin Pass@123 /add
        net localgroup administrators githubadmin /add
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… githubadmin"

    - name: ØªÙ…ÙƒÙŠÙ† RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        echo "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ RDP"

    - name: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
      id: get_ip
      shell: powershell
      run: |
        $ip = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -ne "Loopback Pseudo-Interface 1"} | Select-Object -First 1 -ExpandProperty IPAddress)
        echo "ip_address=$ip" >> $env:GITHUB_OUTPUT

    - name: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø¨Ø± Telegram
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        $msg = "ğŸ”” *Windows RDP Ø¬Ø§Ù‡Ø²!*`n`n*IP:* `${{ steps.get_ip.outputs.ip_address }}``n*Username:* `githubadmin``n*Password:* `Pass@123``nâ±ï¸ *Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ù„ÙŠ Ø®Ù„Ø§Ù„ 6 Ø³Ø§Ø¹Ø§Øª*"
        $url = "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage"
        $body = @{
          chat_id = $env:TELEGRAM_CHAT_ID
          text = $msg
          parse_mode = "Markdown"
        }
        Invoke-RestMethod -Uri $url -Method POST -Body $body

    - name: Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ (loop Ø¥Ø¹Ù„Ø§Ù…ÙŠ)
      shell: pwsh
      run: |
        Write-Host "`n=== RDP ACCESS ==="
        Write-Host "IP: ${{ steps.get_ip.outputs.ip_address }}"
        Write-Host "Username: githubadmin"
        Write-Host "Password: Pass@123"
        Write-Host "==================`n"
        while ($true) {
          Write-Host "[$(Get-Date -Format s)] Ø§Ù„Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©ØŒ Ø³ØªØ¬Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø©."
          Start-Sleep -Seconds 300
        }

    - name: Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Workflow ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      if: always()
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        REPO: ${{ github.repository }}
        WORKFLOW_FILE: rdp.yml   # <-- ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      run: |
        Start-Sleep -Seconds 5
        $uri = "https://api.github.com/repos/$env:REPO/actions/workflows/$env:WORKFLOW_FILE/dispatches"
        $headers = @{
          Authorization = "Bearer $env:GH_TOKEN"
          Accept = "application/vnd.github+json"
          "User-Agent" = "gh-actions-autorestart"
        }
        $body = @{ ref = "${{ github.ref_name || 'main' }}" }
        try {
          Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body ($body | ConvertTo-Json -Depth 4)
          Write-Host "âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Workflow ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§"
        } catch {
          Write-Warning "âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Workflow: $_"
        }
